{% extends "base.html" %}
{% block script %}

<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="{{base_url}}useful.js"></script>
<script src="https://jakiestfu.github.io/Medium.js/bower_components/rangy-official/rangy-core.js"></script>
<script src="https://jakiestfu.github.io/Medium.js/bower_components/rangy-official/rangy-classapplier.js"></script>
<script src="https://jakiestfu.github.io/Medium.js/bower_components/undo/undo.js"></script>
<script src="https://jakiestfu.github.io/Medium.js/medium.js"></script>
<script>
    //    $( window ).load(loadedDiv);
    //    $("#text").ready(loadedDiv);
    function loadedDiv()
    {
        console.log("loaded");
        var div = document.getElementById("text");
        var med = new Medium({
            element: document.getElementById("text"),
            placeholder: "insert text here",
            modifier: 'auto',
            mode: Medium.richMode,
            maxLength: -1,
            autofocus: false,
            autoHR: true,
            modifiers: {
                'b': 'bold',
                'i': 'italicize',
                'u': 'underline',
                'v': 'paste'
            },
            tags: {
                'break': 'div',
                'paragraph': 'p',
                'horizontalRule': 'p'
            },
            cssClasses: {
                editor: 'Medium',
                pasteHook: 'Medium-paste-hook',
                placeholder: 'Medium-placeholder',
                clear: 'Medium-clear'
            },
            keyContext: {
                'enter': function(e, element)
                {
                    var sib = element.previousSibling;
                    console.log("children: " + div.childNodes.length);
                    console.log("html: " + div.innerHTML);
//                    validateTextArea_2();
//                    if(div.innerHTML.charAt(0)!= '<')
//                    {
//						var val = "";
//						var len = 0;
//						for(var i =0; i< div.innerHTML.length; i++)
//						{
//						    if(div.innerHTML.charAt(i) != '<')
//						        val+= div.innerHTML.charAt(i);
//						    else
//							{
//							    len = i;
//						        break;
//						    }
//						}
//						div.innerHTML = div.innerHTML.substr(len, div.innerHTML.length);
//						var par = document.createElement("p");
//						par.appendChild(document.createTextNode(val));
//
//						par.nextSibling(sib);
//						div.clear();
//						div.appendChild(par);
//						sib = par;
//                    }
                    if(sib.tagName != undefined)
                    {
                        if (sib.textContent.trim().match(expC) || sib.textContent.trim().match(expI))
                        {
                            sib.style.color= 'green';
                            sib.textContent= sib.textContent.trim();
                        }
                        else
                        {
                            sib.style.color= 'darkred';
                            sib.textContent= sib.textContent.trim();

                        }
                    }

                },
            }

        });
        med.placeholder=" ";
        //div.className="text-div-editable";
        //med.clear();

    }

	/* Clears the uplaoded file */
    function clearUpload()
    {
        $("#fileupload").val('');
        $("#fileupload").disabled = false;
        $("#text").html('');
    }

	/* Loads and processes the text in the .txt uploaded file. */
    function loadTxt()
    {
        var doc = document.getElementById("fileupload");
        var reader = new FileReader();
        var file = doc.files[0];

        reader.readAsText(file);
        $(reader).on('load', fillUpTxtArea);

    }
	/* Disables upload option when some text is entered in text area. */
    function disableUpload()
    {
        //console.log($('#text').val());
        if( $('#text').text().toString().length != 0)
            document.getElementById("fileupload").disabled = true;
        else
            document.getElementById("fileupload").disabled = false;

    }

	/* WORKS CORECCTLY DO NOT TOUCH. works with innerText*/
    function validateTextArea_2()
    {
        var div = document.getElementById('text');
        console.log(div.innerHTML);
        console.log("text:-"+div.innerText+"-");
        ci_s = div.innerText.split("\n");
        elementsArray = [];
        console.log("ci length: " + ci_s.length);

        for(var i =0; i < ci_s.length-1; i++)
        {
            console.log("ci-s[i]:-" + ci_s[i] +"-end");
            var divEl = document.createElement("DIV");
            if(ci_s[i].trim().length >0)
                var textEl = document.createTextNode(ci_s[i].trim());
            else
                var textEl = document.createTextNode("");
            divEl.appendChild(textEl);
            divEl.appendChild(document.createElement("br"));
            divEl.style.color = 'red';
            if(ci_s[i].match(expC) || ci_s[i].match(expI))
            {
                divEl.style.color = 'green';
            }
            elementsArray[i] = divEl;
        }
        divEl.id="child" + i;
        div.innerText = "";
        div.innerHTML = "";

        console.log("After first try:\n"+div.innerHTML+"end");
        $("#text").empty();
        console.log("After sec try:");
        console.log(div.innerHTML+"end");

        for(var i =0; i < elementsArray.length; i++)
            div.appendChild(elementsArray[i]);

    }

	/* Loads the text in the uploaded text file and fills up the text area with its content. */
    function fillUpTxtArea(e)
    {
        console.log("in fill up");
        var div = document.getElementById('text');
        var file = e.target.result,
            results;
        if (file && file.length) {
            results = file.split("\n");
            var ci = "";
            //todo: use join
            for(var i = 0; i < results.length; i++)
            {
                if(results[i].length!= 0)
                {
                    ci+= results[i];
                    ci+="@" ;//todo: change the char @
                    var spanEl = document.createElement("SPAN");
                    var textEl = document.createTextNode(results[i].toString());
                    spanEl.appendChild(textEl);
                    spanEl.appendChild(document.createElement("br"));
                    div.appendChild(spanEl);
                }
            }
            console.log(results.join("\n"));

            //$("#text").html(results.join("\n"));
            validateTextArea();
        }
    }


	/* called when the form is submitted; call the image */
    function clickSubmit()
    {
        var div = document.getElementById("text");
        var ci_s =processDiv(div.innerText);
        var ci = ci_s.join("@");

		/*Making of ci_s*/
        var wl = $('#wl').val();		// get the wordlength/FPF

		if(wl.length == 0)
		{
		    wl = $('#FPF').val();
		}

		/* build the query */
        var q = '{{base_url}}Constant/' + ci + '?';
        if (msgValidFPF(wl)=='')
            q = q + 'FPF='+wl;
        else
            q = q + 'WL='+wl;
		/* get the json */
        $.ajax({ url: q}).done( function( data)
        {
            html = "";
            html = "<table style=\"width:100%\">\n";
            html += "<tr>\n<th align = left>Const/Interval</th>\n <th align = left>Mantissa</th> \n<th aligne = left>LSB</th>>\n <th align = left>FPF</th>\n<th align = left>Absolute Error</th>\n<th align = left>Real Error</th>\n <th align = left>Status</th>\n </tr>";
            for(i=0; i < Object.keys(data).length; i++)
            {
                html += "<tr>"
                html += "<td>" + ci_s[i]+ "</td>";

                var startStr = "<td>"
                if(data[i]['error'])
                {
                    startStr = "<td style=\"color:darkred\">";
                }
                else
                {
                    startStr = "<td>";
                }
                html += startStr + data[i]["integer"] + "</td>\n";
                html += startStr + data[i]["lsb"] + "</td>\n";
                html += startStr + data[i]["FPF"] + "</td>\n";
                html += startStr + data[i]["error_abs"] + "</td>\n";
                html += startStr + data[i]["error_rel"] + "</td>\n";
                if(data[i]['error'])
                {
                    html += startStr + data[i]["error"] + "</td>\n";
                }
                else
                {
                    html += startStr + "No error" + "</td>\n";
                }
                html += "</tr>";
            }
            html += "</table>";
			/*Table for images: */
            html += "<table style=\"width:100%\">\n";
            html += "<tr>\n<th align = left>Const/Interval</th>\n <th align = left>Image</th></tr>";
            for(i=0; i < Object.keys(data).length; i++)
            {
                html += "<tr>"
                html += "<td  align = left >" + ci_s[i]+ "</td>";
                if(!data[i]['error'])
                {
                    html += "<td  align = left >" + "<a href=\"" + data[i]["FPF_image"] + "\">" + "<img src=" + data[i]["FPF_image"] + " alt=" + "Loading..." + "style=\"width:128px;height:128px;\"	"+"/>" + "</td>\n";
                }
                else
                {
                    html += "<td>" + "<p style=\"color:darkred\" >" + data[i]['error'] + "</p>" +"</td>\n";
                }
                html += "</tr>";
            }
            html += "</table>";

            $("#result").html(html);

        });
    }

    function checkEmpty()
    {
        var text =document.getElementById("text");
        console.log("checked the doc");
        console.log("in check: "+ text.innerHTML);
        if(text.childNodes.length== 0)
        {
            var p = document.createElement("P");
            var intext=document.createElement("br");
            p.appendChild(intext);
            text.appendChild(p);
        }
        console.log("in check: "+ text.innerHTML);
    }
</script>
{% endblock%}


{% block content %}
Blablabla... This page allows to convert a real constant (literal constant or an interval, e.g. <i>0.124</i> or <i>[-100;100]</i>) into a fixed-point representation.

<p>

<div class="container" >
	<div style="display: inline-block">
		<!-- form -->
		<h2 class="heads"> Form</h2>
		<form method="POST" action="javascript:clickSubmit();" id="form" class="wrapper">
			<p  class="constantsLabel tooltip">Constants:
				<span class="tooltiptext">Enter your constants or intervals here</span>
			</p>
			<!-- <textarea id="text" class="yesno" style ="overflow:inherit;" rows="5" cols="10" oninput='disableUpload()' onkeyup="if(event.keyCode == 13 || event.keyCode == 8) verifyConstIntLines(this); else verifyEachChar(this);"/> </textarea></br> -->
			<!--<div id ="bigDiv" style="display: table-row-group;">-->
			<div  id="text" name="text"  contenteditable="true" class = "constantsText" >

				<!--</div>-->
			</div>
			<label class="uploadLabel">Import a file:</label>
			<label  class="uploadButton">
				<input type="file" accept = ".txt" name="fileupload" value="fileupload" id="fileupload" onchange='loadTxt()'>
			</label>
			<label class="five">It will be displayed in the upper text area.</label>
			<label for="wl" class="wlLabel">Word Length: </label>
			<input class="yesno wlInput" id="wl" type="text" onkeyup="verifyWL(this);" size="8"/>
			<label class="FPFLabel"> or the FPF:</label>
			<input class="yesno FPFInput"  id="FPF" type="text"  onkeyup="verifyFPF(this);" size="8"/>
			<button id="file-reset" type="button" onclick="clearUpload()" class="uploadButton resetButton">Reset</button>
			<input type="submit" class="submitButton"/>
		</form>
		<h2 class="heads"> Result</h2>
	<!--  result -->
	</div>
		<div id="result" >

	</div>


</div>

</div>
</div>

<!--
	Fixed-Point Representation: <br/>
	The constant is approximated by: <br/>
	Absolute error: <br/>
	Relative error:<br/>
	<div class="r-container">
	<div id="result">
		<img id='FPF_image'><br/>
		{% for img in imageFormats %}
			<a id='a_{{img}}' href=''>{{img}}</a>&nbsp;&nbsp;
		{% endfor %}
		<br/>
		<table border=1><div id='str_latex'></div></table>
	</div>
 -->





{% endblock %}