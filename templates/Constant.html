{% extends "base.html" %}
{% block script %}

<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="{{base_url}}useful.js"></script>
<script>

/* called when the form is submitted; call the image */

function checkSubmit()
{

    if( $('#text').val().length == 0 &&  $('#fileupload').val().length == 0 )
	{
	    alert("You must either upload a file or enter the constants manually!");
	}
	else if($('#text').val().length != 0 &&  $('#fileupload').val().length != 0 )
	{
	    alert("You can't upload a file and enter constants manually at the same time!");
	}
	else
	{
	    /*Input is given by text area*/
	    if($('#text').val().length != 0 )
		{
		    var ci_s = $('#ci').val().split("\n");
			var ci = "";
			//todo: use join
			for(var i = 0; i < ci_s.length; i++)
			{
	    		if(ci_s[i].length!= 0)
				{
	    			ci+= ci_s[i];
	    			ci+="@" //todo: change the char @
				}
			}

	    	validate(ci, ci_s);
		}
		/*Input is given by file*/
	    else
		{
			var doc = document.getElementById("fileupload");
			var reader = new FileReader();
			var resultingString;
			for(var i = 0; i < doc.files.length; i++)
			{
			    var file = doc.files[i];
				reader.readAsText(file);
        		$(reader).on('load', processFile);
			}


		}
	}
}
function processFile(e) {
    var file = e.target.result,
        results;
    if (file && file.length) {
        results = file.split("\n");
        var ci = "";
			//todo: use join
			for(var i = 0; i < results.length; i++)
			{
	    		if(results[i].length!= 0)
				{
	    			ci+= results[i];
	    			ci+="@" //todo: change the char @
				}
			}

	    	validate(ci, results);
    }
}
function validate(ci, ci_s)
{
    /*Making of ci_s*/
	var wl = $('#wl').val();		// get the wordlength/FPF
	/* build the query */
	var q = '{{base_url}}Constant/' + ci + '?';
	if (msgValidFPF(wl)=='')
		q = q + 'FPF='+wl;
	else
		q = q + 'WL='+wl;
	/* get the json */
	$.ajax({ url: q}).done( function( data)
	{
		html = "";
		html = "<table style=\"width:100%\">\n";
		html += "<tr>\n<th align = left>Const/Interval</th>\n <th align = left>Mentissa</th> \n<th aligne = left>LSB</th>>\n <th align = left>FPF</th>\n<th align = left>Absolute Error</th>\n<th align = left>Real Error</th>\n</tr>";
		for(i=0; i < Object.keys(data).length; i++)
		{
		    html += "<tr>"
			html += "<td>" + ci_s[i]+ "</td>";
		    if(!data[i]['error'])
		    {
                html += "<td>" + data[i]["integer"] + "</td>\n";
                html += "<td>" + data[i]["lsb"] + "</td>\n";
                html += "<td>" + data[i]["FPF"] + "</td>\n";
                html += "<td>" + data[i]["error_abs"] + "</td>\n";
                html += "<td>" + data[i]["error_rel"] + "</td>\n";
            }
            else
			{
				html += "<td>" + data[i]['error'] + "</td>\n";
			}
            html += "</tr>";
		}
		html += "</table>";
		/*Table for images: */
		html += "<table style=\"width:100%\">\n";
		html += "<tr>\n<th align = left>Const/Interval</th>\n <th align = left>Image</th></tr>";
		for(i=0; i < Object.keys(data).length; i++)
		{
		    html += "<tr>"
			html += "<td  align = left >" + ci_s[i]+ "</td>";
		    //TODO: check if the link will later on cause a problem: Ask Hilaire
			if(!data[i]['error'])
			{
                html += "<td  align = left >" + "<a href=\"" + data[i]["FPF_image"] + "\">" + "<img src=" + data[i]["FPF_image"] + " alt=" + "Mountain View" + "/>" + "</td>\n";
            }
            else
			{
				html += "<td>" + data[i]['error'] + "</td>\n";
			}
			html += "</tr>";
		}
		html += "</table>";

		$("#result").html(html);

	});
}


</script>
{% endblock%}


{% block content %}
Blablabla... This page allows to convert a real constant (literal constant or an interval, e.g. <i>0.124</i> or <i>[-100;100]</i>) into a fixed-point representation.

<p>

<div class="container">
	<div>
	<!-- form -->
	<form method="POST" action="javascript:checkSubmit();" id="form">
		<label for="ci">Constants:</label><br><textarea id="text" class="yesno" style ="overflow:inherit" id="ci" rows="5" cols="10" onkeyup="if(event.keyCode == 13 || event.keyCode == 8) verifyConstIntLines(this); else verifyEachChar(this);"/></textarea></br>
		<label for="ci">Or upload the file containing constants and intervals:</label>
		<input type="file" accept = ".txt" name="fileupload" value="fileupload" id="fileupload"><br>
		<label for="wl">Word Length enter it here: <input class="yesno" id="wl" type="text" required onkeyup="verifyFPForWL(this);" size="8"/>
		<input type="submit"/> </label>

	</form>
	</div>
	<!--  result -->
	<div id="result">



	</div>
</div>

	</div>
</div>

<!--
	Fixed-Point Representation: <br/>
	The constant is approximated by: <br/>
	Absolute error: <br/>
	Relative error:<br/>
	<div class="r-container">
	<div id="result">
		<img id='FPF_image'><br/>
		{% for img in imageFormats %}
			<a id='a_{{img}}' href=''>{{img}}</a>&nbsp;&nbsp;
		{% endfor %}
		<br/>
		<table border=1><div id='str_latex'></div></table>
	</div>
 -->





{% endblock %}